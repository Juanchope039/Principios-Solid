#pool:
#  vmImage: ubuntu-latest
#  Image: ubuntu-latest
#  name: Default

variables:
- group: general-variable-Pipelines


stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: CloneRepo
        displayName: Clone repo
        steps:
          - checkout: none
            clean: false
            persistCredentials: true

          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                git clone $(repoGitHub) p
              workingDirectory: '$(Build.BinariesDirectory)'
            displayName: 'Cloning GitHub Repo'
#           Build.BinariesDirectory   -  Build.ArtifactStagingDirectory
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                git switch $(branchName)

                git remote add github $(remoteGitHub)
                git remote add azure $(repoAzure)
              workingDirectory: '$(Build.BinariesDirectory)/p'
            displayName: 'Settings remote Repo'

          - script: |
                echo git pull azure $(branchName)
                git pull azure $(branchName)
            workingDirectory: '$(Build.BinariesDirectory)/p'
            displayName: 'Settings pull Repo'
          - task: PublishPipelineArtifact@1
            inputs:
              artifactName: workingSpace
              targetPath: '$(Build.BinariesDirectory)/p'

      - job: BuidTest
        dependsOn: CloneRepo
        displayName: Build Test
        workspace:
          clean: resources
        steps:
          - checkout: none #skip checking out the default repository resource
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Pipeline Artifact'
            inputs:
              artifactName: workingSpace
              targetPath: '$(Pipeline.Workspace)'
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: 'echo ''Hello world'''
              workingDirectory: '$(Pipeline.Workspace)'
          
#########################################################################

          - task: PublishPipelineArtifact@1
            inputs:
              artifactName: workingSpace
              targetPath: '$(Pipeline.Workspace)'

  - stage: Push
    displayName: Push
    dependsOn: Build 
    jobs:
      - job: PushGitHub
        displayName: Push Git Hub
        steps:
          - checkout: none #skip checking out the default repository resource
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Pipeline Artifact'
            inputs:
              artifactName: workingSpace
              targetPath: '$(Pipeline.Workspace)'
          
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                echo git config --global
                
                git config --global user.email "$(email)"
                git config --global user.name "$(name)"
              workingDirectory: '$(Pipeline.Workspace)'
              displayName: 'Configure Tokens'

          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                #!/bin/bash
                        set -x
                        git config --global credential.helper 'cache --timeout 600'
                        << eof tr -d ' ' | git credential-cache store
                          protocol=https
                          host=github.com
                          username=$(userNameGitHub)
                          password=${GITHUB_TOKEN}
                        eof
              workingDirectory: '$(Pipeline.Workspace)'
              bashEnvValue: 'GITHUB_TOKEN: $(gitHubPath)'
              displayName: 'Cache GitHub credentials.'

          - script: |
                echo git push github $(branchName)
                git push github $(branchName)
            workingDirectory: '$(Pipeline.Workspace)'
            displayName: 'Settings push Repo'